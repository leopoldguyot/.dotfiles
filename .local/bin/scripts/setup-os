#!/usr/bin/env bash
set -euo pipefail

# ======================
# CONFIG
# ======================
DOTFILES_DIR="$HOME/.dotfiles"
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/oh-my-zsh-custom}"
FONT_DIR="$HOME/.fonts"
TMUX_TPM_DIR="$HOME/.config/tmux/tpm"
GH_SRC_DIR="$HOME/.local/src"
LOCAL_BIN="$HOME/.local/bin"
CONFIG_FILE="$HOME/.config/source-tools.conf"

mkdir -p "$GH_SRC_DIR" "$LOCAL_BIN"

# ======================
# DETECT PACKAGE MANAGER
# ======================
if command -v apt &>/dev/null; then
    # Attempt to install nala first if not available
    echo "Detected apt-based system."
    if ! command -v nala &>/dev/null; then
        echo "Installing nala (improved apt frontend)..."
        sudo apt update
        sudo apt install -y nala || echo "Failed to install nala, falling back to apt."
    fi

    if command -v nala &>/dev/null; then
        PKG_MANAGER="nala"
        UPDATE_CMD="sudo nala update && sudo nala upgrade -y"
        INSTALL_CMD="sudo nala install -y"
    else
        PKG_MANAGER="apt"
        UPDATE_CMD="sudo apt update && sudo apt upgrade -y"
        INSTALL_CMD="sudo apt install -y"
    fi

elif command -v dnf &>/dev/null; then
    PKG_MANAGER="dnf"
    UPDATE_CMD="sudo dnf upgrade -y"
    INSTALL_CMD="sudo dnf install -y"

elif command -v pacman &>/dev/null; then
    PKG_MANAGER="pacman"
    UPDATE_CMD="sudo pacman -Syu --noconfirm"
    INSTALL_CMD="sudo pacman -S --noconfirm"

else
    echo "Unsupported package manager. Install manually."
    exit 1
fi

echo "Using package manager: $PKG_MANAGER"
echo

# ======================
# PACKAGE LISTS
# ======================

# ---- Common base packages ----
BASE_COMMON="git stow tmux zsh fzf curl wget  fontconfig gh neofetch firefox htop btop"
DEV_COMMON="cmake ninja-build gettext unzip pkg-config libtool autoconf automake g++ rustup python3 python3-pip pipx"
R_PACKAGES="r-base r-base-dev"
NETWORK_TOOLS="network-manager"

# ---- Common WM packages ----
I3_COMMON="i3 i3status i3lock dmenu feh thunar"
SWAY_COMMON="sway"

# ---- Per-distro specifics ----
case "$PKG_MANAGER" in
    apt|nala)
        BASE_PACKAGES="$BASE_COMMON $DEV_COMMON $R_PACKAGES $NETWORK_TOOLS build-essential \
            libtool-bin libfontconfig1-dev libxcb-xfixes0-dev libxkbcommon-dev"
        I3_EXTRA="xbacklight"
        SWAY_EXTRA=""
        ;;
    dnf)
        BASE_PACKAGES="$BASE_COMMON $DEV_COMMON $R_PACKAGES $NETWORK_TOOLS @development-tools \
            libtool fontconfig-devel libxcb-devel libxkbcommon-devel"
        I3_EXTRA="xbacklight"
        SWAY_EXTRA=""
        ;;
    pacman)
        BASE_PACKAGES="$BASE_COMMON $DEV_COMMON $R_PACKAGES $NETWORK_TOOLS base-devel \
            libtool fontconfig libxcb libxkbcommon"
        I3_EXTRA="xorg-xbacklight i3-wm"
        SWAY_EXTRA=""
        ;;
esac

# Merge the lists
I3_PACKAGES="$I3_COMMON $I3_EXTRA"
SWAY_PACKAGES="$SWAY_COMMON $SWAY_EXTRA"

# ======================
# UPDATE SYSTEM
# ======================
echo "Updating system..."
$UPDATE_CMD

# ======================
# INSTALL BASE PACKAGES
# ======================
echo "Installing base packages..."
$INSTALL_CMD $BASE_PACKAGES

# ======================
# INSTALL WM PACKAGES
# ======================
echo
echo "Optional window manager installation"
echo "1) i3 (X11)"
echo "2) Sway (Wayland)"
echo "3) None"
read -rp "Choose an option [1/2/3]: " wm_choice

case "$wm_choice" in
    1)
        echo "Installing i3 packages..."
        $INSTALL_CMD $I3_PACKAGES
        ;;
    2)
        echo "Installing Sway packages..."
        $INSTALL_CMD $SWAY_PACKAGES
        ;;
    3)
        echo "Skipping extra window manager packages."
        ;;
    *)
        echo "Invalid choice, skipping extra packages."
        ;;
esac
echo

# ======================
# OH MY ZSH
# ======================
echo "Installing oh-my-zsh..."
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    RUNZSH=no CHSH=no KEEP_ZSHRC=yes sh -c \
        "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# ======================
# ZSH PLUGINS
# ======================
mkdir -p "$ZSH_CUSTOM/plugins"
for plugin in zsh-autosuggestions zsh-syntax-highlighting; do
    if [ ! -d "$ZSH_CUSTOM/plugins/$plugin" ]; then
        echo "Installing Zsh plugin: $plugin"
        git clone https://github.com/zsh-users/$plugin.git "$ZSH_CUSTOM/plugins/$plugin"
    else
        echo "Zsh plugin $plugin already installed, skipping."
    fi
done

# ======================
# TMUX TPM
# ======================
if [ ! -d "$TMUX_TPM_DIR" ]; then
    git clone https://github.com/tmux-plugins/tpm "$TMUX_TPM_DIR"
fi

# ======================
# RADIAN
# ======================
if ! command -v radian &>/dev/null; then
    pipx install radian
fi

# ======================
# DOTFILES
# ======================
if [ -x "$DOTFILES_DIR/.local/bin/scripts/sync-dotfiles" ]; then
    bash "$DOTFILES_DIR/.local/bin/scripts/sync-dotfiles"
fi

# ======================
# DEFAULT SHELL
# ======================
CURRENT_SHELL=$(basename "$SHELL")
ZSH_PATH=$(which zsh)

if [ "$CURRENT_SHELL" != "zsh" ]; then
    echo
    read -rp "Do you want to change your default shell to Zsh? [y/N]: " change_shell
    case "$change_shell" in
        [yY]|[yY][eE][sS])
            chsh -s "$ZSH_PATH"
            echo "Default shell changed to Zsh. Please log out and back in for changes to take effect."
            ;;
        *)
            echo "Skipping changing default shell."
            ;;
    esac
fi

# ======================
# FONTS
# ======================
mkdir -p "$FONT_DIR"
cd "$FONT_DIR"
curl -OL https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraMono.tar.xz
tar xf FiraMono.tar.xz
fc-cache -fv

# ======================
# SOURCE TOOLS
# ======================
echo "Installing from source..."
if [ -x "$LOCAL_BIN/scripts/update-source" ]; then
    bash "$LOCAL_BIN/scripts/update-source"
fi

echo "Setup complete. Log out and back in for changes to take effect."

